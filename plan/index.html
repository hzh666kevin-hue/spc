<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>æ—¶é—´è§„åˆ’ â€” SPC</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/design-system.css">
<style>
  .tbl th{position:sticky;top:0;z-index:2;background:var(--bg-secondary);font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.04em;color:var(--text-tertiary);padding:10px 14px;text-align:left;border-bottom:2px solid var(--border-default);white-space:nowrap}
  .tbl td{padding:10px 14px;border-bottom:1px solid var(--border-subtle);font-size:13px;color:var(--text-primary);vertical-align:middle}
  .tbl tr:hover td{background:var(--bg-tertiary)}
  .q-badge{padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;white-space:nowrap}
  .q1{background:rgba(239,68,68,0.1);color:#DC2626;border:1px solid rgba(239,68,68,0.2)}
  .q2{background:rgba(59,130,246,0.1);color:#2563EB;border:1px solid rgba(59,130,246,0.2)}
  .q3{background:rgba(245,158,11,0.1);color:#D97706;border:1px solid rgba(245,158,11,0.2)}
  .q4{background:rgba(107,114,128,0.1);color:#6B7280;border:1px solid rgba(107,114,128,0.2)}
  .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .filter-tab{padding:6px 14px;border-radius:8px;font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;color:var(--text-secondary);background:transparent;border:none;white-space:nowrap}
  .filter-tab.active{background:var(--brand-50);color:var(--brand-600);font-weight:600}
  .filter-tab:hover:not(.active){background:var(--bg-tertiary)}
  .kanban-col{min-width:280px;flex:1}
  .kanban-card{border-radius:12px;padding:12px;cursor:grab;transition:all .15s}
  .kanban-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
  .kanban-card:active{cursor:grabbing}
  .timer-display{font-variant-numeric:tabular-nums;font-family:'Inter',monospace}
</style>
</head>
<body class="flex h-screen">

<!-- ===== ä¾§æ  ===== -->
<aside class="w-[200px] min-w-[200px] h-full flex flex-col border-r" style="background:var(--bg-secondary);border-color:var(--border-default)">
  <div class="p-3">
    <div class="flex items-center gap-2 mb-3">
      <div class="w-7 h-7 rounded-lg bg-gradient-to-br from-violet-500 to-purple-600 flex items-center justify-center">
        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25"/></svg>
      </div>
      <span class="text-sm font-bold" style="color:var(--text-primary)">æ—¶é—´è§„åˆ’</span>
    </div>
    <div class="relative mb-3">
      <svg class="w-3.5 h-3.5 absolute left-2.5 top-1/2 -translate-y-1/2" style="color:var(--text-tertiary)" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
      <input type="text" id="search" oninput="render()" placeholder="æœç´¢ä»»åŠ¡ã€é¡¹ç›®ã€åˆ†ç±»..." class="input text-xs pl-8 py-1.5">
    </div>
  </div>

  <nav class="flex-1 overflow-y-auto px-2 space-y-0.5">
    <div class="px-2 py-1 text-[9px] font-semibold uppercase tracking-wider" style="color:var(--text-tertiary)">è§†å›¾</div>
    <button onclick="setView('table')" class="folder-item w-full active" data-view="table" style="padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:8px;transition:all .15s;color:var(--text-secondary);background:none;border:none;width:100%;text-align:left">
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z"/></svg>
      ä»»åŠ¡åˆ—è¡¨
    </button>
    <button onclick="setView('kanban')" class="folder-item w-full" data-view="kanban" style="padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:8px;transition:all .15s;color:var(--text-secondary);background:none;border:none;width:100%;text-align:left">
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 4.5v15m6-15v15m-10.875 0h15.75c.621 0 1.125-.504 1.125-1.125V5.625c0-.621-.504-1.125-1.125-1.125H4.125C3.504 4.5 3 5.004 3 5.625v12.75c0 .621.504 1.125 1.125 1.125z"/></svg>
      çœ‹æ¿è§†å›¾
    </button>
    <button onclick="setView('analytics')" class="folder-item w-full" data-view="analytics" style="padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:8px;transition:all .15s;color:var(--text-secondary);background:none;border:none;width:100%;text-align:left">
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/></svg>
      æ•°æ®åˆ†æ
    </button>

    <div class="h-px my-2" style="background:var(--border-default)"></div>
    <div class="px-2 py-1 text-[9px] font-semibold uppercase tracking-wider" style="color:var(--text-tertiary)">é¡¹ç›®</div>
    <div id="project-list"></div>
  </nav>

  <!-- ç•ªèŒ„é’Ÿ -->
  <div class="border-t p-3" style="border-color:var(--border-default)">
    <div class="text-[10px] mb-2 flex items-center gap-1" style="color:var(--text-tertiary)">
      <svg class="w-3 h-3 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
      ç•ªèŒ„é’Ÿ <span class="ml-auto font-bold text-violet-500" id="pom-rounds"></span>
    </div>
    <div class="text-center mb-2">
      <div class="relative w-[68px] h-[68px] mx-auto">
        <svg class="w-[68px] h-[68px] -rotate-90" viewBox="0 0 68 68"><circle cx="34" cy="34" r="30" fill="none" stroke-width="4" style="stroke:var(--border-default)"/><circle id="pom-circle" cx="34" cy="34" r="30" fill="none" stroke="#8B5CF6" stroke-width="4" stroke-dasharray="188.5" stroke-dashoffset="0" stroke-linecap="round" class="transition-all duration-1000"/></svg>
        <span class="absolute inset-0 flex items-center justify-center text-sm font-mono font-bold" id="pom-time" style="color:var(--text-primary)">25:00</span>
      </div>
    </div>
    <div class="flex gap-1 justify-center">
      <button onclick="pomAction()" id="pom-btn" class="btn btn-sm" style="background:rgba(139,92,246,0.1);color:#7C3AED;border:1px solid rgba(139,92,246,0.2)">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z"/></svg>å¼€å§‹</button>
      <button onclick="pomReset()" class="btn btn-secondary btn-sm">é‡ç½®</button>
    </div>
  </div>
</aside>

<!-- ===== ä¸»å†…å®¹ ===== -->
<main class="flex-1 flex flex-col overflow-hidden" style="background:var(--bg-primary)">

  <!-- å½“å‰ä»»åŠ¡æ  (FutureLens é£æ ¼) -->
  <div id="active-task-bar" class="min-h-[56px] flex items-center gap-4 px-5 border-b" style="border-color:var(--border-default);background:var(--bg-secondary)">
    <div class="flex items-center gap-2 flex-1 min-w-0">
      <span class="badge text-[10px]" style="background:rgba(34,197,94,0.1);color:#16A34A;border:1px solid rgba(34,197,94,0.2)">å½“å‰ä»»åŠ¡</span>
      <span class="status-dot" id="active-dot" style="background:#22C55E"></span>
      <span class="text-sm font-semibold truncate" id="active-name" style="color:var(--text-primary)">æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡</span>
      <span class="timer-display text-lg font-bold ml-2" id="active-timer" style="color:var(--brand-600)">0h 0m 0s</span>
    </div>
    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="flex gap-3 shrink-0">
      <div class="text-center px-3 py-1 rounded-lg" style="background:var(--bg-primary)">
        <div class="text-xs font-bold" id="stat-today-count" style="color:var(--text-primary)">0</div>
        <div class="text-[9px]" style="color:var(--text-tertiary)">ä»Šæ—¥ä»»åŠ¡</div>
      </div>
      <div class="text-center px-3 py-1 rounded-lg" style="background:var(--bg-primary)">
        <div class="text-xs font-bold text-emerald-500" id="stat-done-count">0</div>
        <div class="text-[9px]" style="color:var(--text-tertiary)">å·²å®Œæˆ</div>
      </div>
      <div class="text-center px-3 py-1 rounded-lg" style="background:var(--bg-primary)">
        <div class="text-xs font-bold text-violet-500 timer-display" id="stat-total-time">0h 0m</div>
        <div class="text-[9px]" style="color:var(--text-tertiary)">æ€»è€—æ—¶</div>
      </div>
    </div>
  </div>

  <!-- å·¥å…·æ  -->
  <div class="flex items-center gap-2 px-5 py-2 border-b" style="border-color:var(--border-subtle)">
    <button onclick="openAdd()" class="btn btn-primary btn-sm">
      <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>åˆ›å»ºä»»åŠ¡</button>
    <div class="h-4 w-px mx-1" style="background:var(--border-default)"></div>
    <!-- æ—¶é—´ç­›é€‰ -->
    <button onclick="setFilter('today')" class="filter-tab" data-filter="today">ä»Šæ—¥ä»»åŠ¡</button>
    <button onclick="setFilter('week')" class="filter-tab" data-filter="week">æœ¬å‘¨ä»»åŠ¡</button>
    <button onclick="setFilter('month')" class="filter-tab" data-filter="month">æœ¬æœˆä»»åŠ¡</button>
    <button onclick="setFilter('all')" class="filter-tab active" data-filter="all">å…¨éƒ¨ä»»åŠ¡</button>
    <div class="flex-1"></div>
    <span class="text-[11px]" style="color:var(--text-tertiary)" id="filter-info">å…± 0 æ¡</span>
  </div>

  <!-- å†…å®¹åŒº -->
  <div class="flex-1 overflow-auto" id="content-area">
    <!-- è¡¨æ ¼è§†å›¾ -->
    <div id="view-table">
      <table class="tbl w-full">
        <thead><tr>
          <th style="width:50px">çŠ¶æ€</th>
          <th>ä»»åŠ¡</th>
          <th>é¡¹ç›®</th>
          <th>åˆ†ç±»</th>
          <th>é‡è¦æ€§</th>
          <th>æ—¥æœŸ</th>
          <th>è€—æ—¶</th>
          <th style="width:80px">æ“ä½œ</th>
        </tr></thead>
        <tbody id="task-tbody"></tbody>
      </table>
    </div>
    <!-- çœ‹æ¿è§†å›¾ -->
    <div id="view-kanban" class="hidden p-4 flex gap-4 h-full overflow-x-auto"></div>
    <!-- æ•°æ®åˆ†æ -->
    <div id="view-analytics" class="hidden p-6 max-w-4xl mx-auto"></div>
  </div>
</main>

<!-- ç¼–è¾‘å¼¹çª— -->
<div id="modal" class="overlay" style="background:var(--bg-overlay);backdrop-filter:blur(6px)" onclick="if(event.target===this)closeModal()">
  <div class="modal w-[560px] max-w-[95vw]">
    <div class="flex items-center justify-between px-6 py-4 border-b" style="border-color:var(--border-subtle)">
      <h3 class="text-sm font-semibold" id="modal-title" style="color:var(--text-primary)">åˆ›å»ºä»»åŠ¡</h3>
      <button onclick="closeModal()" class="btn btn-ghost btn-icon btn-sm">&times;</button>
    </div>
    <div class="p-6 space-y-3">
      <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">ä»»åŠ¡åç§° *</label><input id="f-name" class="input text-xs" placeholder="è¾“å…¥ä»»åŠ¡åç§°..."></div>
      <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">æè¿°</label><textarea id="f-desc" rows="2" class="input text-xs resize-none" placeholder="ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea></div>
      <div class="grid grid-cols-3 gap-3">
        <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">ä¼˜å…ˆçº§</label><select id="f-prio" class="input text-xs"><option value="high">ğŸ”´ é«˜ (Q1/Q3)</option><option value="medium" selected>ğŸŸ¡ ä¸­ (Q2)</option><option value="low">ğŸ”µ ä½ (Q4)</option></select></div>
        <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">æˆªæ­¢æ—¥æœŸ</label><input id="f-due" type="date" class="input text-xs"></div>
        <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">é¢„è®¡æ—¶é—´(åˆ†é’Ÿ)</label><input id="f-est" type="number" class="input text-xs" placeholder="30" min="0"></div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">é¡¹ç›®</label><input id="f-proj" class="input text-xs" placeholder="é¡¹ç›®å..." list="project-list-datalist"></div>
        <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">åˆ†ç±»</label><input id="f-cat" class="input text-xs" placeholder="å¦‚ï¼šå­¦ä¹ ã€å·¥ä½œã€å¥èº«..."></div>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">é‡å¤</label><select id="f-repeat" class="input text-xs"><option value="">ä¸é‡å¤</option><option value="daily">æ¯å¤©</option><option value="weekly">æ¯å‘¨</option><option value="monthly">æ¯æœˆ</option></select></div>
        <div><label class="text-[10px] font-medium block mb-1" style="color:var(--text-secondary)">æ ‡ç­¾</label><input id="f-tags" class="input text-xs" placeholder="ç”¨é€—å·åˆ†éš”ï¼Œå¦‚: é‡è¦,ç´§æ€¥"></div>
      </div>
    </div>
    <div class="flex gap-2 justify-end px-6 pb-5"><button onclick="closeModal()" class="btn btn-secondary btn-sm">å–æ¶ˆ</button><button onclick="saveTask()" class="btn btn-primary btn-sm">ä¿å­˜</button></div>
  </div>
</div>
<datalist id="project-list-datalist"></datalist>

<script>
const KEY='trisync_tasks';
let tasks=[],view='table',editId=null,activeProject='',timeFilter='all',activeTimerId=null,timerInterval=null;
let pomTime=25*60,pomLeft=25*60,pomRunning=false,pomRounds=0,pomTimer=null;

function load(){try{tasks=JSON.parse(localStorage.getItem(KEY)||'[]').map(t=>({...t,subtasks:t.subtasks||[],tags:typeof t.tags==='string'?(t.tags?t.tags.split(','):[]):(t.tags||[]),category:t.category||'',timeSpent:t.timeSpent||0,estimatedTime:t.estimatedTime||0,repeat:t.repeat||''}))}catch{tasks=[]}}
function save(){localStorage.setItem(KEY,JSON.stringify(tasks))}

// Eisenhower quadrant classification
function getQuadrant(t){
  const urgent=t.dueDate&&(()=>{const d=new Date(t.dueDate+'T00:00:00'),today=new Date();today.setHours(0,0,0,0);return(d-today)/864e5<=3})();
  const important=t.priority==='high';
  if(important&&urgent)return{label:'Q1 é‡è¦ä¸”ç´§æ€¥',cls:'q1'};
  if(important&&!urgent)return{label:'Q2 é‡è¦ä¸ç´§æ€¥',cls:'q2'};
  if(!important&&urgent)return{label:'Q3 ç´§æ€¥ä¸é‡è¦',cls:'q3'};
  return{label:'Q4 ä¸é‡è¦ä¸ç´§æ€¥',cls:'q4'};
}

function formatTime(sec){const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60;if(h>0)return h+'h '+m+'m';if(m>0)return m+'m '+s+'s';return s+'s'}
function timeAgo(ts){if(!ts)return'--';const s=Math.floor((Date.now()-ts)/1000);if(s<60)return'åˆšåˆš';const m=Math.floor(s/60);if(m<60)return m+'åˆ†é’Ÿå‰';const h=Math.floor(m/60);if(h<24)return h+'å°æ—¶å‰';return new Date(ts).toLocaleDateString('zh-CN')}

// Time filter
function matchesFilter(t){
  if(timeFilter==='all')return true;
  if(!t.dueDate)return timeFilter==='all';
  const d=new Date(t.dueDate+'T00:00:00'),now=new Date();now.setHours(0,0,0,0);
  const diff=(d-now)/864e5;
  if(timeFilter==='today')return diff>=0&&diff<1;
  if(timeFilter==='week')return diff>=0&&diff<7;
  if(timeFilter==='month')return diff>=0&&diff<30;
  return true;
}

function setFilter(f){timeFilter=f;document.querySelectorAll('.filter-tab').forEach(b=>b.classList.toggle('active',b.dataset.filter===f));render()}
function setView(v){view=v;document.querySelectorAll('[data-view]').forEach(b=>{b.style.background=b.dataset.view===v?'rgba(79,70,229,0.08)':'';b.style.color=b.dataset.view===v?'var(--brand-600)':'var(--text-secondary)';b.style.fontWeight=b.dataset.view===v?'500':'400'});
  document.getElementById('view-table').classList.toggle('hidden',v!=='table');document.getElementById('view-kanban').classList.toggle('hidden',v!=='kanban');document.getElementById('view-analytics').classList.toggle('hidden',v!=='analytics');render()}

function render(){
  const q=document.getElementById('search').value.toLowerCase();
  const filtered=tasks.filter(t=>{if(activeProject&&t.project!==activeProject)return false;if(!matchesFilter(t))return false;if(!q)return true;return(t.name+t.description+t.project+t.category).toLowerCase().includes(q)});
  const done=tasks.filter(t=>t.status==='done').length,doing=tasks.filter(t=>t.status==='doing').length;
  const totalTime=tasks.reduce((s,t)=>s+(t.timeSpent||0),0);
  const todayStr=new Date().toISOString().slice(0,10);
  const todayCount=tasks.filter(t=>t.dueDate===todayStr).length;
  document.getElementById('filter-info').textContent='å…± '+filtered.length+' æ¡';
  document.getElementById('stat-today-count').textContent=todayCount;
  document.getElementById('stat-done-count').textContent=done;
  document.getElementById('stat-total-time').textContent=formatTime(totalTime);
  // Active task
  const act=tasks.find(t=>t.status==='doing');
  document.getElementById('active-name').textContent=act?act.name:'æš‚æ— è¿›è¡Œä¸­çš„ä»»åŠ¡';
  document.getElementById('active-dot').style.background=act?'#22C55E':'var(--text-tertiary)';
  // Projects
  const projects=[...new Set(tasks.map(t=>t.project).filter(Boolean))].sort();
  let ph='<button onclick="activeProject=\'\';render()" style="padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:8px;width:100%;text-align:left;border:none;transition:all .15s;background:'+(activeProject===''?'rgba(79,70,229,0.08)':'transparent')+';color:'+(activeProject===''?'var(--brand-600)':'var(--text-secondary)')+'"><span style="width:6px;height:6px;border-radius:50%;background:var(--text-tertiary)"></span>å…¨éƒ¨ ('+tasks.length+')</button>';
  projects.forEach(p=>{const c=tasks.filter(t=>t.project===p).length;const col=['#6366F1','#06B6D4','#22C55E','#F59E0B','#EF4444','#EC4899'][Math.abs([...p].reduce((h,c)=>c.charCodeAt(0)+(h<<5)-h,0))%6];ph+='<button onclick="activeProject=\''+p+'\';render()" style="padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:8px;width:100%;text-align:left;border:none;transition:all .15s;background:'+(activeProject===p?'rgba(79,70,229,0.08)':'transparent')+';color:'+(activeProject===p?'var(--brand-600)':'var(--text-secondary)')+'"><span style="width:6px;height:6px;border-radius:50%;background:'+col+'"></span>'+p+' ('+c+')</button>'});
  document.getElementById('project-list').innerHTML=ph;

  if(view==='table')renderTable(filtered);
  else if(view==='kanban')renderKanban(filtered);
  else renderAnalytics();
}

function renderTable(filtered){
  let h='';filtered.forEach(t=>{
    const q=getQuadrant(t);const dotColor=t.status==='done'?'#22C55E':t.status==='doing'?'#F59E0B':'var(--text-tertiary)';
    const overdue=t.dueDate&&t.dueDate<new Date().toISOString().slice(0,10)&&t.status!=='done';
    const tagsHtml=(t.tags||[]).length?'<div class="flex gap-1 mt-1">'+(t.tags||[]).slice(0,3).map(tag=>'<span class="text-[9px] px-1 py-0.5 rounded" style="background:rgba(99,102,241,0.1);color:var(--brand-600)">'+tag+'</span>').join('')+'</div>':'';
    const repeatHtml=t.repeat?'<span class="text-[9px] ml-1" title="é‡å¤ä»»åŠ¡">ğŸ”„</span>':'';
    h+=`<tr>
      <td><button onclick="cycleStatus('${t.id}')" title="åˆ‡æ¢çŠ¶æ€"><span class="status-dot" style="background:${dotColor}"></span></button></td>
      <td><div class="font-medium ${t.status==='done'?'line-through':''}" style="color:${t.status==='done'?'var(--text-tertiary)':'var(--text-primary)'}">${t.name}${repeatHtml}</div>${t.description?'<div class="text-[10px] truncate" style="color:var(--text-tertiary);max-width:250px">'+t.description+'</div>':''}${tagsHtml}</td>
      <td>${t.project?'<span class="text-xs" style="color:var(--brand-600)">â‰¡ '+t.project+'</span>':''}</td>
      <td>${t.category?'<span class="text-[11px] px-1.5 py-0.5 rounded" style="background:var(--bg-tertiary);color:var(--text-secondary)">'+t.category+'</span>':''}</td>
      <td><span class="q-badge ${q.cls}">${q.label}</span></td>
      <td>${t.dueDate?'<span class="text-xs '+(overdue?'font-bold':'')+'" style="color:'+(overdue?'var(--danger)':'var(--text-secondary)')+'">'+t.dueDate+'</span>':'<span class="text-[10px]" style="color:var(--text-tertiary)">--</span>'}</td>
      <td><div class="text-xs" style="color:var(--text-secondary)"><span class="timer-display">${formatTime(t.timeSpent||0)}</span>${t.estimatedTime?'/<span class="timer-display" style="color:var(--text-tertiary)">'+t.estimatedTime+'m</span>':''}</div></td>
      <td><div class="flex gap-0.5">
        <button onclick="toggleTimer('${t.id}')" class="btn btn-ghost btn-xs" title="${activeTimerId===t.id?'åœæ­¢è®¡æ—¶':'å¼€å§‹è®¡æ—¶'}"><svg class="w-3.5 h-3.5 ${activeTimerId===t.id?'text-red-500':'text-emerald-500'}" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="${activeTimerId===t.id?'M15.75 5.25v13.5m-7.5-13.5v13.5':'M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z'}"/></svg></button>
        <button onclick="openEdit('${t.id}')" class="btn btn-ghost btn-xs"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931z"/></svg></button>
        <button onclick="deleteTask('${t.id}')" class="btn btn-ghost btn-xs" style="color:var(--danger)"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79"/></svg></button>
      </div></td>
    </tr>`});
  if(!h)h='<tr><td colspan="8" class="text-center py-16"><div class="w-14 h-14 rounded-2xl mx-auto mb-3 flex items-center justify-center" style="background:var(--bg-tertiary)"><svg class="w-7 h-7 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25"/></svg></div><div class="text-sm font-medium mb-1" style="color:var(--text-primary)">æš‚æ— ä»»åŠ¡</div><div class="text-xs" style="color:var(--text-tertiary)">ç‚¹å‡»ã€Œåˆ›å»ºä»»åŠ¡ã€å¼€å§‹è§„åˆ’ä½ çš„æ—¶é—´</div></td></tr>';
  document.getElementById('task-tbody').innerHTML=h;
}

function renderKanban(filtered){
  const cols=[{key:'todo',label:'å¾…åŠ',color:'#64748B',bg:'rgba(100,116,139,0.04)'},{key:'doing',label:'è¿›è¡Œä¸­',color:'#F59E0B',bg:'rgba(245,158,11,0.04)'},{key:'done',label:'å·²å®Œæˆ',color:'#22C55E',bg:'rgba(34,197,94,0.04)'}];
  let h='';cols.forEach(col=>{
    const items=filtered.filter(t=>t.status===col.key);
    h+=`<div class="kanban-col flex flex-col rounded-xl overflow-hidden" style="background:${col.bg};border:1px solid var(--border-subtle)" ondragover="event.preventDefault()" ondrop="dropTask(event,'${col.key}')">
      <div class="px-4 py-3 flex items-center gap-2 border-b" style="border-color:var(--border-subtle)"><span class="status-dot" style="background:${col.color}"></span><span class="text-xs font-semibold" style="color:${col.color}">${col.label}</span><span class="badge text-[9px]">${items.length}</span></div>
      <div class="flex-1 overflow-y-auto p-2 space-y-2">${items.map(t=>{
        const q=getQuadrant(t);
        return`<div class="kanban-card" style="background:var(--bg-elevated);border:1px solid var(--border-default)" draggable="true" ondragstart="event.dataTransfer.setData('id','${t.id}')">
          <div class="text-xs font-medium mb-1" style="color:var(--text-primary)">${t.name}</div>
          <div class="flex items-center gap-1.5 flex-wrap">
            <span class="q-badge ${q.cls}" style="font-size:9px;padding:1px 6px">${q.label}</span>
            ${t.project?'<span class="text-[9px]" style="color:var(--text-tertiary)">'+t.project+'</span>':''}
            ${t.dueDate?'<span class="text-[9px]" style="color:var(--text-tertiary)">ğŸ“… '+t.dueDate+'</span>':''}
          </div>
        </div>`}).join('')}</div>
    </div>`;
  });
  document.getElementById('view-kanban').innerHTML=h;
}

function renderAnalytics(){
  const total=tasks.length,done=tasks.filter(t=>t.status==='done').length,doing=tasks.filter(t=>t.status==='doing').length,todo=total-done-doing;
  const pct=total?Math.round(done/total*100):0;
  const totalTime=tasks.reduce((s,t)=>s+(t.timeSpent||0),0);
  // Project breakdown
  const projMap={};tasks.forEach(t=>{const p=t.project||'æœªåˆ†ç±»';if(!projMap[p])projMap[p]={count:0,done:0,time:0};projMap[p].count++;if(t.status==='done')projMap[p].done++;projMap[p].time+=(t.timeSpent||0)});
  const projEntries=Object.entries(projMap).sort((a,b)=>b[1].time-a[1].time);
  const colors=['#6366F1','#06B6D4','#22C55E','#F59E0B','#EF4444','#EC4899','#8B5CF6','#14B8A6'];

  // SVG donut chart
  let donutPaths='',angleStart=0;const r=60,cx=80,cy=80;
  if(total>0){projEntries.forEach(([name,data],i)=>{const pct=data.count/total;const angle=pct*360;const endAngle=angleStart+angle;const large=angle>180?1:0;const x1=cx+r*Math.cos((angleStart-90)*Math.PI/180),y1=cy+r*Math.sin((angleStart-90)*Math.PI/180);const x2=cx+r*Math.cos((endAngle-90)*Math.PI/180),y2=cy+r*Math.sin((endAngle-90)*Math.PI/180);
    donutPaths+=`<path d="M${cx},${cy} L${x1},${y1} A${r},${r} 0 ${large},1 ${x2},${y2} Z" fill="${colors[i%colors.length]}" opacity="0.85"><title>${name}: ${data.count}ä¸ªä»»åŠ¡</title></path>`;angleStart=endAngle})}

  document.getElementById('view-analytics').innerHTML=`
    <h2 class="text-lg font-bold mb-1" style="color:var(--text-primary)">æ•°æ®åˆ†æ</h2>
    <p class="text-xs mb-6" style="color:var(--text-secondary)">ä»»åŠ¡ç»Ÿè®¡ä¸é¡¹ç›®åˆ†å¸ƒ</p>
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="card p-4 text-center"><div class="text-2xl font-bold" style="color:var(--text-primary)">${total}</div><div class="text-[11px]" style="color:var(--text-secondary)">æ€»ä»»åŠ¡</div></div>
      <div class="card p-4 text-center"><div class="text-2xl font-bold text-emerald-500">${done}</div><div class="text-[11px]" style="color:var(--text-secondary)">å·²å®Œæˆ</div></div>
      <div class="card p-4 text-center"><div class="text-2xl font-bold timer-display" style="color:var(--brand-600)">${formatTime(totalTime)}</div><div class="text-[11px]" style="color:var(--text-secondary)">æ€»è€—æ—¶</div></div>
      <div class="card p-4 text-center">
        <div class="relative w-12 h-12 mx-auto"><svg class="w-12 h-12 -rotate-90" viewBox="0 0 48 48"><circle cx="24" cy="24" r="20" fill="none" stroke-width="4" style="stroke:var(--border-default)"/><circle cx="24" cy="24" r="20" fill="none" stroke="#6366F1" stroke-width="4" stroke-linecap="round" stroke-dasharray="${2*Math.PI*20}" stroke-dashoffset="${2*Math.PI*20*(1-pct/100)}"/></svg><span class="absolute inset-0 flex items-center justify-center text-[10px] font-bold" style="color:var(--text-primary)">${pct}%</span></div>
        <div class="text-[11px] mt-1" style="color:var(--text-secondary)">å®Œæˆç‡</div>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-6">
      <div class="card p-5">
        <div class="text-xs font-semibold mb-3" style="color:var(--text-primary)">æŒ‰é¡¹ç›®åˆ†å¸ƒ</div>
        <div class="flex items-center gap-6">
          <svg viewBox="0 0 160 160" width="140" height="140">${donutPaths||'<circle cx="80" cy="80" r="60" fill="var(--bg-tertiary)"/>'}<circle cx="80" cy="80" r="38" fill="var(--bg-elevated)"/><text x="80" y="76" text-anchor="middle" font-size="18" font-weight="bold" fill="var(--text-primary)">${total}</text><text x="80" y="92" text-anchor="middle" font-size="10" fill="var(--text-tertiary)">ä»»åŠ¡</text></svg>
          <div class="space-y-2 flex-1">${projEntries.map(([name,data],i)=>`<div class="flex items-center gap-2"><span class="w-2.5 h-2.5 rounded-sm shrink-0" style="background:${colors[i%colors.length]}"></span><span class="text-xs flex-1 truncate" style="color:var(--text-primary)">${name}</span><span class="text-[10px] font-mono" style="color:var(--text-secondary)">${data.count}</span><span class="text-[10px]" style="color:var(--text-tertiary)">${total?Math.round(data.count/total*100):0}%</span></div>`).join('')}</div>
        </div>
      </div>
      <div class="card p-5">
        <div class="text-xs font-semibold mb-3" style="color:var(--text-primary)">é¡¹ç›®è¯¦æƒ…</div>
        <table class="w-full text-xs"><thead><tr><th class="text-left py-1.5 font-medium" style="color:var(--text-tertiary)">é¡¹ç›®</th><th class="text-right py-1.5 font-medium" style="color:var(--text-tertiary)">ä»»åŠ¡</th><th class="text-right py-1.5 font-medium" style="color:var(--text-tertiary)">å®Œæˆåº¦</th><th class="text-right py-1.5 font-medium" style="color:var(--text-tertiary)">è€—æ—¶</th></tr></thead>
        <tbody>${projEntries.map(([name,data],i)=>`<tr><td class="py-1.5"><span class="flex items-center gap-1.5"><span class="w-2 h-2 rounded-sm" style="background:${colors[i%colors.length]}"></span>${name}</span></td><td class="text-right" style="color:var(--text-secondary)">${data.count}</td><td class="text-right" style="color:var(--text-secondary)">${data.count?Math.round(data.done/data.count*100):0}%</td><td class="text-right timer-display" style="color:var(--text-secondary)">${formatTime(data.time)}</td></tr>`).join('')}</tbody></table>
      </div>
    </div>`;
}

// CRUD
function openAdd(){editId=null;document.getElementById('modal-title').textContent='åˆ›å»ºä»»åŠ¡';['f-name','f-desc','f-proj','f-cat','f-tags','f-est'].forEach(id=>document.getElementById(id).value='');document.getElementById('f-prio').value='medium';document.getElementById('f-due').value='';document.getElementById('f-repeat').value='';document.getElementById('modal').classList.add('visible');updateProjectDatalist()}
function openEdit(id){const t=tasks.find(x=>x.id===id);if(!t)return;editId=id;document.getElementById('modal-title').textContent='ç¼–è¾‘ä»»åŠ¡';document.getElementById('f-name').value=t.name;document.getElementById('f-desc').value=t.description||'';document.getElementById('f-prio').value=t.priority;document.getElementById('f-due').value=t.dueDate||'';document.getElementById('f-proj').value=t.project||'';document.getElementById('f-cat').value=t.category||'';document.getElementById('f-est').value=t.estimatedTime||'';document.getElementById('f-repeat').value=t.repeat||'';document.getElementById('f-tags').value=(t.tags||[]).join(', ');document.getElementById('modal').classList.add('visible');updateProjectDatalist()}
function closeModal(){document.getElementById('modal').classList.remove('visible')}
function updateProjectDatalist(){const projects=[...new Set(tasks.map(t=>t.project).filter(Boolean))];document.getElementById('project-list-datalist').innerHTML=projects.map(p=>'<option value="'+p+'">').join('')}
function saveTask(){const tagsInput=document.getElementById('f-tags').value;const tags=tagsInput?tagsInput.split(',').map(t=>t.trim()).filter(t=>t):[];const t={id:editId||crypto.randomUUID(),name:document.getElementById('f-name').value,description:document.getElementById('f-desc').value,status:'todo',priority:document.getElementById('f-prio').value,project:document.getElementById('f-proj').value,category:document.getElementById('f-cat').value,tags:tags,dueDate:document.getElementById('f-due').value,estimatedTime:parseInt(document.getElementById('f-est').value)||0,repeat:document.getElementById('f-repeat').value,timeSpent:0,subtasks:[],createdAt:Date.now(),updatedAt:Date.now()};if(editId){const i=tasks.findIndex(x=>x.id===editId);if(i>=0){t.status=tasks[i].status;t.createdAt=tasks[i].createdAt;t.timeSpent=tasks[i].timeSpent;tasks[i]=t}}else tasks.unshift(t);save();closeModal();render();handleRepeatTasks(t)}
function handleRepeatTasks(t){if(!t.repeat||t.status!=='done')return;const nextDue=calculateNextDue(t.dueDate,t.repeat);if(nextDue){const newTask={...t,id:crypto.randomUUID(),status:'todo',dueDate:nextDue,createdAt:Date.now(),updatedAt:Date.now()};tasks.unshift(newTask);save()}}
function calculateNextDue(currentDue,repeatType){if(!currentDue)return null;const d=new Date(currentDue);if(repeatType==='daily')d.setDate(d.getDate()+1);else if(repeatType==='weekly')d.setDate(d.getDate()+7);else if(repeatType==='monthly')d.setMonth(d.getMonth()+1);return d.toISOString().slice(0,10)}
function deleteTask(id){if(!confirm('ç¡®è®¤åˆ é™¤ï¼Ÿ'))return;tasks=tasks.filter(t=>t.id!==id);if(activeTimerId===id)stopTimer();save();render()}
function cycleStatus(id){const map={todo:'doing',doing:'done',done:'todo'};tasks=tasks.map(t=>t.id===id?{...t,status:map[t.status],updatedAt:Date.now()}:t);save();render()}
function dropTask(e,status){const id=e.dataTransfer.getData('id');tasks=tasks.map(t=>t.id===id?{...t,status,updatedAt:Date.now()}:t);save();render()}

// Timer
function toggleTimer(id){if(activeTimerId===id){stopTimer()}else{stopTimer();activeTimerId=id;tasks=tasks.map(t=>t.id===id?{...t,status:'doing',updatedAt:Date.now()}:t);timerInterval=setInterval(()=>{tasks=tasks.map(t=>t.id===activeTimerId?{...t,timeSpent:(t.timeSpent||0)+1}:t);const t=tasks.find(x=>x.id===activeTimerId);if(t)document.getElementById('active-timer').textContent=formatTime(t.timeSpent);save()},1000);render()}}
function stopTimer(){if(timerInterval)clearInterval(timerInterval);activeTimerId=null;timerInterval=null;render()}

// Pomodoro
function updatePom(){const m=Math.floor(pomLeft/60),s=pomLeft%60;document.getElementById('pom-time').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');const prog=pomTime>0?((pomTime-pomLeft)/pomTime)*188.5:0;document.getElementById('pom-circle').setAttribute('stroke-dashoffset',188.5-prog);document.getElementById('pom-rounds').textContent=pomRounds>0?'Ã—'+pomRounds:''}
function pomAction(){if(pomRunning){pomRunning=false;clearInterval(pomTimer);document.getElementById('pom-btn').innerHTML='<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z"/></svg>ç»§ç»­';return}pomRunning=true;document.getElementById('pom-btn').innerHTML='<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25v13.5m-7.5-13.5v13.5"/></svg>æš‚åœ';pomTimer=setInterval(()=>{if(pomLeft<=0){clearInterval(pomTimer);pomRunning=false;pomRounds++;pomLeft=pomTime;updatePom();document.getElementById('pom-btn').innerHTML='<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z"/></svg>å¼€å§‹';return}pomLeft--;updatePom()},1000)}
function pomReset(){pomRunning=false;clearInterval(pomTimer);pomLeft=pomTime;updatePom();document.getElementById('pom-btn').innerHTML='<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 5.653c0-.856.917-1.398 1.667-.986l11.54 6.348a1.125 1.125 0 010 1.971l-11.54 6.347a1.125 1.125 0 01-1.667-.985V5.653z"/></svg>å¼€å§‹'}

load();render();updatePom();
</script>
</body>
</html>
