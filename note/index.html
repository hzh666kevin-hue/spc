<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>ç¬”è®° â€” SPC</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../css/design-system.css">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; overflow: hidden; }
  .note-item{padding:10px 12px;border-radius:10px;cursor:pointer;transition:all .15s;margin:2px 6px}
  .note-item:hover{background:var(--bg-tertiary)}
  .note-item.active{background:rgba(79,70,229,0.1);border-left:3px solid var(--brand-600)}
  .section-title{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--text-tertiary);padding:8px 12px 6px}
  .view-btn{padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:8px;transition:all .15s;color:var(--text-secondary);background:none;border:none;width:100%;text-align:left}
  .view-btn:hover{background:var(--bg-tertiary)}
  .view-btn.active{background:rgba(79,70,229,0.1);color:var(--brand-600);font-weight:500}
  .folder-btn{padding:6px 12px;border-radius:8px;cursor:pointer;font-size:12px;display:flex;align-items:center;gap:6px;transition:all .15s;color:var(--text-secondary);background:none;border:none;width:100%;text-align:left}
  .folder-btn:hover{background:var(--bg-tertiary)}
  .folder-btn.active{background:rgba(79,70,229,0.1);color:var(--brand-600);font-weight:500}
  .folder-btn .count{margin-left:auto;font-size:10px;color:var(--text-tertiary)}
  .add-folder-btn{padding:8px 12px;border-radius:8px;cursor:pointer;font-size:11px;display:flex;align-items:center;gap:6px;transition:all .15s;color:var(--text-tertiary);background:none;border:none;width:100%;text-align:left;border:1px dashed var(--border-default);margin:4px 8px}
  .add-folder-btn:hover{background:var(--bg-tertiary);border-color:var(--brand-300);color:var(--brand-600)}
  .md-body{font-family:'Inter','PingFang SC',sans-serif;font-size:15px;line-height:1.8;color:var(--text-primary);max-width:720px;margin:0 auto}
  .md-body h1{font-size:28px;font-weight:700;margin:40px 0 12px;letter-spacing:-.02em}
  .md-body h2{font-size:22px;font-weight:600;margin:32px 0 10px;padding-bottom:8px;border-bottom:1px solid var(--border-subtle)}
  .md-body h3{font-size:18px;font-weight:600;margin:24px 0 8px}
  .md-body p{margin:0 0 12px}
  .md-body ul,.md-body ol{margin:8px 0 16px;padding-left:24px}
  .md-body li{margin:4px 0}
  .md-body blockquote{margin:16px 0;padding:12px 16px;background:#FFFBEB;border-left:4px solid #F59E0B;border-radius:0 8px 8px 0;color:#92400E;font-style:normal}
  .md-body code{font-family:'JetBrains Mono',monospace;font-size:13px;background:var(--bg-tertiary);color:#E11D48;padding:2px 6px;border-radius:4px}
  .md-body pre{background:var(--bg-secondary);border:1px solid var(--border-default);border-radius:12px;padding:16px 20px;margin:16px 0;overflow-x:auto}
  .md-body pre code{background:transparent;color:var(--text-primary);padding:0}
  .md-body a{color:var(--brand-600);text-decoration:none;border-bottom:1px solid transparent}
  .md-body a:hover{border-bottom-color:var(--brand-600)}
  .md-body hr{border:none;height:1px;background:var(--border-default);margin:32px 0}
  .md-body table{width:100%;border-collapse:collapse;margin:16px 0;font-size:13px}
  .md-body th{background:var(--bg-secondary);padding:8px 12px;text-align:left;font-weight:600;border-bottom:2px solid var(--border-default);font-size:11px;text-transform:uppercase;letter-spacing:.04em;color:var(--text-tertiary)}
  .md-body td{padding:8px 12px;border-bottom:1px solid var(--border-subtle)}
  .md-body img{max-width:100%;border-radius:8px;margin:12px 0}
  .md-body input[type="checkbox"]{accent-color:var(--brand-600);margin-right:6px}
  .editor-textarea{font-family:'JetBrains Mono','Fira Code',monospace;font-size:14px;line-height:1.7;color:var(--text-primary);background:transparent;resize:none;outline:none;border:none;width:100%;height:100%;min-height:400px}
  .toolbar-btn{width:28px;height:28px;border-radius:6px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;color:var(--text-tertiary);background:none;border:none}
  .toolbar-btn:hover{background:var(--bg-tertiary);color:var(--text-primary)}
  .view-tab{padding:4px 12px;border-radius:6px;font-size:11px;font-weight:500;cursor:pointer;transition:all .15s;background:transparent;border:none;color:var(--text-tertiary);display:inline-block}
  .view-tab.active{background:var(--brand-50);color:var(--brand-600)}
  .btn{padding:6px 12px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;transition:all .15s;border:none}
  .btn-primary{background:var(--brand-600);color:white}
  .btn-primary:hover{background:var(--brand-700)}
  .btn-secondary{background:var(--bg-tertiary);color:var(--text-primary)}
  .btn-secondary:hover{background:var(--border-default)}
  .input{padding:6px 10px;border-radius:8px;border:1px solid var(--border-default);background:var(--bg-primary);color:var(--text-primary);font-size:13px;width:100%}
  .input:focus{outline:none;border-color:var(--brand-500);box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
  .badge{padding:2px 8px;border-radius:99px;font-size:11px;font-weight:500}
  .side-panel{width:220px;min-width:220px;border-left:1px solid var(--border-subtle);background:var(--bg-secondary);overflow-y:auto}
  .version-item{padding:8px 12px;border-radius:8px;cursor:pointer;transition:all .15s;margin:2px 6px}
  .version-item:hover{background:var(--bg-tertiary)}
  .backlink-item{padding:8px 10px;border-radius:8px;cursor:pointer;transition:all .15s;margin:2px 0;font-size:12px}
  .backlink-item:hover{background:var(--bg-tertiary)}
  .hidden{display:none !important}
  .nav-link{padding:8px 12px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .15s;color:var(--text-secondary);background:none;border:none;width:100%;text-align:left;font-size:12px}
  .nav-link:hover{background:var(--bg-tertiary);color:var(--text-primary)}
  .trash-note{opacity:0.5}
  .trash-note:hover{opacity:1}
</style>
</head>
<body class="flex h-screen overflow-hidden" style="font-family:'Inter',sans-serif">

<!-- ===== ä¾§æ  ===== -->
<aside class="w-[260px] min-w-[260px] h-full flex flex-col border-r" style="background:var(--bg-secondary);border-color:var(--border-default)">
  <!-- å¤´éƒ¨ï¼šè¿”å›ä¸»é¡µ -->
  <div class="p-3 border-b" style="border-color:var(--border-default)">
    <button onclick="if(window.parent !== window){window.parent.postMessage({action:'navigate',module:'home'},'*')}else{window.location.href='../index.html'}" class="w-full flex items-center gap-2 px-2 py-1.5 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
      <svg class="w-4 h-4" style="color:var(--text-tertiary)" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
      <span class="text-xs font-medium" style="color:var(--text-secondary)">è¿”å›ä¸»é¡µ</span>
    </button>
  </div>
  
  <!-- æ ‡é¢˜åŒº -->
  <div class="p-3">
    <div class="flex items-center gap-2 mb-3">
      <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center shadow-md">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
      </div>
      <span class="text-base font-bold" style="color:var(--text-primary)">ç¬”è®°</span>
      <button onclick="createNote()" class="ml-auto w-8 h-8 rounded-lg flex items-center justify-center bg-emerald-600 text-white hover:bg-emerald-700 transition-all shadow-sm hover:shadow" title="æ–°å»ºç¬”è®° (Ctrl+N)">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
      </button>
    </div>
    <div class="relative">
      <svg class="w-4 h-4 absolute left-2.5 top-1/2 -translate-y-1/2" style="color:var(--text-tertiary)" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/></svg>
      <input type="text" id="search" oninput="renderList()" placeholder="æœç´¢ç¬”è®°..." class="input text-xs pl-8 py-2">
    </div>
  </div>

  <!-- è§†å›¾é€‰æ‹© -->
  <div class="px-2">
    <div class="section-title">è§†å›¾</div>
    <button onclick="setView('all')" class="view-btn" id="view-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
      å…¨éƒ¨ç¬”è®°
      <span class="count" id="count-all"></span>
    </button>
    <button onclick="setView('pinned')" class="view-btn" id="view-pinned">
      <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>
      æ˜Ÿæ ‡ç¬”è®°
      <span class="count" id="count-pinned"></span>
    </button>
    <button onclick="setView('trash')" class="view-btn" id="view-trash">
      <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79"/></svg>
      åºŸçº¸ç¯“
      <span class="count" id="count-trash"></span>
    </button>
  </div>

  <div class="h-px my-2 mx-3" style="background:var(--border-default)"></div>

  <!-- æ–‡ä»¶å¤¹åˆ—è¡¨ -->
  <div class="flex-1 overflow-y-auto">
    <div class="flex items-center justify-between px-3">
      <div class="section-title" style="padding:8px 0 6px">æ–‡ä»¶å¤¹</div>
      <button onclick="addNewFolder()" class="text-[10px] hover:underline" style="color:var(--brand-600);background:none;border:none;cursor:pointer;padding:4px">+ æ–°å»º</button>
    </div>
    <div id="folder-list" class="px-2"></div>
    
    <!-- ç¬”è®°åˆ—è¡¨ -->
    <div class="mt-2" id="note-list-container">
      <div class="section-title">ç¬”è®°</div>
      <div id="note-list"></div>
    </div>
  </div>

  <!-- åº•éƒ¨çŠ¶æ€ -->
  <div class="flex items-center justify-between px-3 py-2 border-t text-[10px]" style="border-color:var(--border-default);color:var(--text-tertiary)">
    <span id="note-count">0 ç¯‡ç¬”è®°</span>
    <div class="flex gap-1">
      <button onclick="exportNotes()" class="toolbar-btn" style="width:22px;height:22px" title="å¯¼å‡º"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"/></svg></button>
      <button onclick="importNotes()" class="toolbar-btn" style="width:22px;height:22px" title="å¯¼å…¥"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg></button>
    </div>
  </div>
</aside>

<!-- ===== ä¸»å†…å®¹ ===== -->
<main class="flex-1 flex overflow-hidden" style="background:var(--bg-primary)">

  <!-- ç©ºçŠ¶æ€ -->
  <div class="flex-1 flex items-center justify-center" id="empty-state">
    <div class="text-center">
      <div class="w-20 h-20 rounded-3xl mx-auto mb-5 flex items-center justify-center" style="background:linear-gradient(135deg,var(--brand-100),var(--brand-50))">
        <svg class="w-10 h-10" style="color:var(--brand-500)" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
      </div>
      <div class="text-lg font-semibold mb-2" style="color:var(--text-primary)">åˆ›å»ºä½ çš„ç¬¬ä¸€ç¯‡ç¬”è®°</div>
      <div class="text-sm mb-5" style="color:var(--text-tertiary)">æ”¯æŒ Markdown è¯­æ³• Â· Wiki é“¾æ¥ [[æ ‡é¢˜]] Â· ç‰ˆæœ¬å†å²</div>
      <button onclick="createNote()" class="btn btn-primary px-6 py-2.5 text-sm shadow-lg hover:shadow-xl transition-all">
        <svg class="w-4 h-4 inline mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>æ–°å»ºç¬”è®°</button>
    </div>
  </div>

  <!-- ç¼–è¾‘åŒº -->
  <div class="flex-1 flex flex-col hidden" id="editor-area">
    <!-- æ ‡é¢˜æ  -->
    <div class="flex items-center gap-3 px-6 py-3 border-b" style="border-color:var(--border-default)">
      <button onclick="goBackToList()" class="toolbar-btn" title="è¿”å›åˆ—è¡¨">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18"/></svg>
      </button>
      <input type="text" id="note-title" placeholder="æ— æ ‡é¢˜ç¬”è®°" class="flex-1 bg-transparent text-xl font-bold outline-none" style="color:var(--text-primary)" oninput="autoSave()">
      <button onclick="togglePin()" class="toolbar-btn" id="pin-btn" title="æ˜Ÿæ ‡">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>
      </button>
      <span class="text-[10px]" id="save-status" style="color:#22C55E">å·²ä¿å­˜</span>
      
      <!-- ç¼–è¾‘/é¢„è§ˆåˆ‡æ¢ -->
      <div class="flex gap-0.5 p-0.5 rounded-lg" style="background:var(--bg-tertiary)">
        <button onclick="setEditMode('edit')" class="view-tab active" id="tab-edit">ç¼–è¾‘</button>
        <button onclick="setEditMode('preview')" class="view-tab" id="tab-preview">é¢„è§ˆ</button>
        <button onclick="setEditMode('split')" class="view-tab" id="tab-split">åˆ†å±</button>
      </div>
      
      <button onclick="toggleSidePanel()" class="toolbar-btn" id="panel-toggle" title="æ˜¾ç¤º/éšè—ä¾§è¾¹é¢æ¿">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503 3.498l4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 00-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0z"/></svg>
      </button>
      
      <button onclick="moveToTrash()" class="toolbar-btn" id="trash-btn" title="ç§»åˆ°åºŸçº¸ç¯“">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79"/></svg>
      </button>
    </div>

    <!-- æ ‡ç­¾æ  + æ–‡ä»¶å¤¹ -->
    <div class="flex items-center gap-2 px-6 py-1.5 border-b min-h-[32px]" style="border-color:var(--border-subtle)">
      <button onclick="promptSelectFolder()" class="flex items-center gap-1 text-[10px] hover:underline" style="color:var(--text-tertiary);background:none;border:none;cursor:pointer">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/></svg>
        <span id="folder-display">æ— æ–‡ä»¶å¤¹</span>
      </button>
      <span style="color:var(--border-subtle)">|</span>
      <svg class="w-3 h-3 shrink-0" style="color:var(--text-tertiary)" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z"/></svg>
      <div id="tag-display" class="flex gap-1 flex-wrap"></div>
      <button onclick="promptAddTag()" class="text-[10px] hover:underline" style="color:var(--text-tertiary);background:none;border:none;cursor:pointer">+ æ ‡ç­¾</button>
    </div>

    <!-- Markdown å·¥å…·æ  -->
    <div class="flex items-center gap-0.5 px-6 py-1 border-b flex-wrap" style="border-color:var(--border-subtle)" id="md-toolbar">
      <button onclick="insertMd('# ')" class="toolbar-btn text-xs font-bold" title="æ ‡é¢˜">H1</button>
      <button onclick="insertMd('## ')" class="toolbar-btn text-xs font-bold" title="äºŒçº§æ ‡é¢˜">H2</button>
      <button onclick="insertMd('### ')" class="toolbar-btn text-xs font-bold" title="ä¸‰çº§æ ‡é¢˜">H3</button>
      <span class="w-px h-4 mx-0.5" style="background:var(--border-default)"></span>
      <button onclick="insertMd('**','**')" class="toolbar-btn text-xs font-bold" title="åŠ ç²—">B</button>
      <button onclick="insertMd('*','*')" class="toolbar-btn text-xs italic" title="æ–œä½“">I</button>
      <button onclick="insertMd('~~','~~')" class="toolbar-btn text-xs line-through" title="åˆ é™¤çº¿">S</button>
      <button onclick="insertMd('`','`')" class="toolbar-btn" title="è¡Œå†…ä»£ç "><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5"/></svg></button>
      <span class="w-px h-4 mx-0.5" style="background:var(--border-default)"></span>
      <button onclick="insertMd('- ')" class="toolbar-btn" title="åˆ—è¡¨"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg></button>
      <button onclick="insertMd('- [ ] ')" class="toolbar-btn" title="å¾…åŠ"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></button>
      <button onclick="insertMd('> ')" class="toolbar-btn" title="å¼•ç”¨"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.087.16 2.185.283 3.293.369V21l4.076-4.076a1.526 1.526 0 011.037-.443 48.282 48.282 0 005.68-.494c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z"/></svg></button>
      <button onclick="insertMd('```\n','\n```')" class="toolbar-btn" title="ä»£ç å—"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 9.75L16.5 12l-2.25 2.25m-4.5 0L7.5 12l2.25-2.25M6 20.25h12A2.25 2.25 0 0020.25 18V6A2.25 2.25 0 0018 3.75H6A2.25 2.25 0 003.75 6v12A2.25 2.25 0 006 20.25z"/></svg></button>
      <button onclick="insertMd('\n---\n')" class="toolbar-btn" title="åˆ†å‰²çº¿"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 12h-15"/></svg></button>
      <button onclick="insertMd('[','](url)')" class="toolbar-btn" title="é“¾æ¥"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/></svg></button>
      <button onclick="insertMd('[[',']]')" class="toolbar-btn" title="Wikié“¾æ¥" style="font-size:11px;font-weight:600">[[]]</button>
    </div>

    <!-- ç¼–è¾‘ / é¢„è§ˆåŒºåŸŸ -->
    <div class="flex-1 flex overflow-hidden" id="editor-container">
      <!-- ç¼–è¾‘å™¨ -->
      <div class="flex-1 overflow-auto p-6" id="edit-pane">
        <textarea id="note-content" class="editor-textarea" style="max-width:720px;margin:0 auto;display:block" placeholder="å¼€å§‹ä¹¦å†™... æ”¯æŒ Markdown è¯­æ³•&#10;&#10;è¾“å…¥ [[æ ‡é¢˜]] åˆ›å»º Wiki é“¾æ¥"></textarea>
      </div>
      <!-- Markdown é¢„è§ˆ -->
      <div class="flex-1 overflow-auto p-6 hidden border-l" id="preview-pane" style="border-color:var(--border-subtle)">
        <div class="md-body" id="preview-content"></div>
      </div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="flex items-center gap-4 px-6 py-1.5 border-t text-[10px]" style="border-color:var(--border-default);color:var(--text-tertiary)">
      <span id="char-count">0 å­—</span>
      <span id="word-count">0 è¯</span>
      <span id="line-count">0 è¡Œ</span>
      <span id="update-time">--</span>
      <span class="ml-auto font-mono">Markdown</span>
    </div>
  </div>

  <!-- ä¾§è¾¹é¢æ¿: ç‰ˆæœ¬å†å² + åå‘é“¾æ¥ -->
  <div class="side-panel hidden" id="side-panel">
    <div class="p-2">
      <!-- ç‰ˆæœ¬å†å² -->
      <div class="mb-4">
        <div class="flex items-center gap-1 px-2 py-1.5 text-[10px] font-semibold uppercase tracking-wider" style="color:var(--text-tertiary)">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          ç‰ˆæœ¬å†å²
        </div>
        <div id="version-list"></div>
      </div>
      <!-- åå‘é“¾æ¥ -->
      <div>
        <div class="flex items-center gap-1 px-2 py-1.5 text-[10px] font-semibold uppercase tracking-wider" style="color:var(--text-tertiary)">
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244"/></svg>
          åå‘é“¾æ¥
        </div>
        <div id="backlink-list"></div>
      </div>
    </div>
  </div>
</main>

<script>
console.log('[Note] Loading note module...');

const KEY='trisync_notes';
let notes=[],activeId=null,saveTimer=null,editMode='edit',activeView='all',activeFolder='',showSidePanel=false;

// åŠ è½½æ•°æ®
function load(){
  console.log('[Note] Loading data...');
  try{
    const data = localStorage.getItem(KEY);
    notes = JSON.parse(data || '[]').map(n => ({
      ...n,
      tags: n.tags || [],
      pinned: n.pinned || false,
      deleted: n.deleted || false,
      versions: n.versions || [],
      folder: n.folder || ''
    }));
    console.log('[Note] Loaded notes:', notes.length);
  } catch(e) {
    console.error('[Note] Load error:', e);
    notes = [];
  }
}

// ä¿å­˜æ•°æ®
function save(){
  try {
    localStorage.setItem(KEY, JSON.stringify(notes));
  } catch(e) {
    console.error('[Note] Save error:', e);
  }
}

// æ—¶é—´æ ¼å¼åŒ–
function timeAgo(ts){
  if(!ts) return '--';
  const s = Math.floor((Date.now() - ts) / 1000);
  if(s < 60) return 'åˆšåˆš';
  const m = Math.floor(s / 60);
  if(m < 60) return m + 'åˆ†å‰';
  const h = Math.floor(m / 60);
  if(h < 24) return h + 'æ—¶å‰';
  const d = Math.floor(h / 24);
  if(d === 1) return 'æ˜¨å¤©';
  return d + 'å¤©å‰';
}

// è§†å›¾åˆ‡æ¢
function setView(view){
  activeView = view;
  activeFolder = '';
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('view-' + view).classList.add('active');
  renderList();
}

// æ¸²æŸ“æ–‡ä»¶å¤¹åˆ—è¡¨
function renderFolderList(){
  const folders = [...new Set(notes.filter(n => !n.deleted).map(n => n.folder).filter(Boolean))].sort();
  let h = '';
  folders.forEach(f => {
    const count = notes.filter(n => n.folder === f && !n.deleted).length;
    const colors = ['#6366F1', '#06B6D4', '#22C55E', '#F59E0B', '#EF4444', '#EC4899', '#8B5CF6', '#14B8A6'];
    const color = colors[Math.abs([...f].reduce((h,c)=>c.charCodeAt(0)+(h<<5)-h,0)) % colors.length];
    h += '<button onclick="setFolder(\'' + f + '\')" class="folder-btn" style="--depth:0"><svg class="w-3.5 h-3.5" style="color:' + color + '" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/></svg>' + f + '<span class="count">' + count + '</span></button>';
  });
  document.getElementById('folder-list').innerHTML = h;
}

// è®¾ç½®å½“å‰æ–‡ä»¶å¤¹
function setFolder(folder){
  activeFolder = folder;
  activeView = 'all';
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  renderList();
}

// æ–°å»ºæ–‡ä»¶å¤¹
function addNewFolder(){
  const folder = prompt('è¾“å…¥æ–°æ–‡ä»¶å¤¹åç§°:');
  if(folder && folder.trim()){
    // ä¸è‡ªåŠ¨åˆ›å»ºï¼Œåªæ˜¯æç¤ºç”¨æˆ·æŠŠç¬”è®°ç§»å…¥è¯¥æ–‡ä»¶å¤¹
    alert('åˆ›å»ºæ–‡ä»¶å¤¹æˆåŠŸï¼æ‚¨å¯ä»¥åœ¨ç¬”è®°ç¼–è¾‘é¡µé¢å°†ç¬”è®°ç§»å…¥è¯¥æ–‡ä»¶å¤¹ã€‚');
  }
}

// æ¸²æŸ“ç¬”è®°åˆ—è¡¨
function renderList(){
  console.log('[Note] Rendering list...');
  
  // æ›´æ–°è§†å›¾è®¡æ•°
  document.getElementById('count-all').textContent = notes.filter(n => !n.deleted).length;
  document.getElementById('count-pinned').textContent = notes.filter(n => n.pinned && !n.deleted).length;
  document.getElementById('count-trash').textContent = notes.filter(n => n.deleted).length;
  
  renderFolderList();

  const q = document.getElementById('search').value.toLowerCase();
  
  // è¿‡æ»¤ç¬”è®°
  let filtered = notes.filter(n => {
    if(activeView === 'trash') return n.deleted;
    if(activeView === 'pinned') return n.pinned && !n.deleted;
    return !n.deleted;
  });
  
  // æ–‡ä»¶å¤¹è¿‡æ»¤
  if(activeFolder){
    filtered = filtered.filter(n => n.folder === activeFolder);
  }
  
  // æœç´¢è¿‡æ»¤
  if(q){
    filtered = filtered.filter(n => (n.title + n.content).toLowerCase().includes(q));
  }
  
  // æ’åº
  filtered.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0) || b.updatedAt - a.updatedAt);

  // æ¸²æŸ“åˆ—è¡¨
  let h = '';
  filtered.forEach(n => {
    const preview = (n.content || '').replace(/[#*_~`>\[\]()-]/g, '').replace(/\n+/g, ' ').trim().slice(0, 80);
    const title = n.title || 'æ— æ ‡é¢˜ç¬”è®°';
    const isTrash = n.deleted ? 'trash-note' : '';
    h += '<div class="note-item ' + isTrash + ' ' + (n.id === activeId ? 'active' : '') + '" onclick="selectNote(\'' + n.id + '\')">' +
      '<div class="flex items-center gap-1"><div class="text-sm font-medium truncate" style="color:' + (n.id === activeId ? 'var(--brand-600)' : 'var(--text-primary)') + '">' + 
      (n.pinned ? '<svg class="w-3 h-3 text-amber-400 inline mr-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>' : '') + 
      title + '</div></div>' +
      (preview ? '<div class="text-xs mt-1 truncate" style="color:var(--text-tertiary)">' + preview + '</div>' : '') +
      '<div class="flex items-center gap-2 mt-1"><span class="text-[10px]" style="color:var(--text-tertiary)">' + timeAgo(n.updatedAt) + '</span>' + 
      (n.folder ? '<span class="text-[9px] px-1.5 py-0.5 rounded bg-[var(--bg-tertiary)]" style="color:var(--text-secondary)">' + n.folder + '</span>' : '') + 
      ((n.tags || []).length ? '<span class="text-[9px]" style="color:var(--text-tertiary)">#' + n.tags.length + '</span>' : '') + '</div></div>';
  });
  
  document.getElementById('note-list').innerHTML = h || '<div class="px-3 py-8 text-center text-xs" style="color:var(--text-tertiary)">' + (activeView === 'trash' ? 'åºŸçº¸ç¯“æ˜¯ç©ºçš„' : 'æš‚æ— ç¬”è®°') + '</div>';
  document.getElementById('note-count').textContent = notes.filter(n => !n.deleted).length + ' ç¯‡ç¬”è®°';
}

// é€‰æ‹©ç¬”è®°
function selectNote(id){
  console.log('[Note] Selecting note:', id);
  activeId = id;
  renderList();
  const n = notes.find(x => x.id === id);
  if(!n) return;
  
  document.getElementById('empty-state').classList.add('hidden');
  document.getElementById('editor-area').classList.remove('hidden');
  document.getElementById('note-title').value = n.title || '';
  document.getElementById('note-content').value = n.content || '';
  
  // æ›´æ–°æ˜Ÿæ ‡æŒ‰é’®
  const pinBtn = document.getElementById('pin-btn');
  if(n.pinned){
    pinBtn.innerHTML = '<svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 24 24"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>';
  } else {
    pinBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>';
  }
  
  // åºŸçº¸ç¯“ä¸­æ˜¾ç¤ºæ¢å¤æŒ‰é’®
  const trashBtn = document.getElementById('trash-btn');
  if(n.deleted){
    trashBtn.innerHTML = '<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" title="æ¢å¤ç¬”è®°"><path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"/></svg>';
    trashBtn.onclick = () => restoreFromTrash();
  } else {
    trashBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" title="ç§»åˆ°åºŸçº¸ç¯“"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79"/></svg>';
    trashBtn.onclick = () => moveToTrash();
  }
  
  updatePreview();
  updateCounts();
  updateTags();
  updateFolder();
  updateSidePanel();
  document.getElementById('update-time').textContent = timeAgo(n.updatedAt);
}

// è¿”å›åˆ—è¡¨
function goBackToList(){
  document.getElementById('editor-area').classList.add('hidden');
  document.getElementById('empty-state').classList.remove('hidden');
  activeId = null;
  renderList();
}

// åˆ‡æ¢æ˜Ÿæ ‡
function togglePin(){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  n.pinned = !n.pinned;
  save();
  selectNote(activeId);
  renderList();
}

// ç§»åˆ°åºŸçº¸ç¯“
function moveToTrash(){
  if(!activeId || !confirm('ç¡®è®¤ç§»åˆ°åºŸçº¸ç¯“ï¼Ÿ')) return;
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  n.deleted = true;
  save();
  goBackToList();
}

// ä»åºŸçº¸ç¯“æ¢å¤
function restoreFromTrash(){
  if(!activeId) return;
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  n.deleted = false;
  save();
  selectNote(activeId);
  renderList();
}

// åˆ›å»ºç¬”è®°
function createNote(){
  console.log('[Note] Creating new note...');
  const n = {
    id: crypto.randomUUID(),
    title: '',
    content: '',
    folder: activeFolder || '',
    tags: [],
    pinned: false,
    deleted: false,
    versions: [],
    createdAt: Date.now(),
    updatedAt: Date.now()
  };
  notes.unshift(n);
  save();
  activeId = n.id;
  renderList();
  selectNote(n.id);
  document.getElementById('note-title').focus();
  console.log('[Note] Note created:', n.id);
}

// è‡ªåŠ¨ä¿å­˜
function autoSave(){
  if(!activeId) return;
  document.getElementById('save-status').textContent = 'ä¿å­˜ä¸­...';
  document.getElementById('save-status').style.color = '#F59E0B';
  
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    const n = notes.find(x => x.id === activeId);
    if(!n) return;
    
    // ä¿å­˜ç‰ˆæœ¬
    const newContent = document.getElementById('note-content').value || '';
    if(n.content && Math.abs(newContent.length - n.content.length) > 50) {
      if(!n.versions) n.versions = [];
      n.versions.push({title: n.title, content: n.content, timestamp: n.updatedAt});
      if(n.versions.length > 20) n.versions.shift();
    }
    
    n.title = document.getElementById('note-title').value;
    n.content = newContent;
    n.updatedAt = Date.now();
    
    save();
    renderList();
    updateCounts();
    updatePreview();
    updateSidePanel();
    
    document.getElementById('save-status').textContent = 'å·²ä¿å­˜';
    document.getElementById('save-status').style.color = '#22C55E';
    document.getElementById('update-time').textContent = 'åˆšåˆš';
  }, 600);
}

// æ›´æ–°é¢„è§ˆ
function updatePreview(){
  if(editMode === 'edit') return;
  const content = document.getElementById('note-content').value || '';
  const processed = content.replace(/\[\[([^\]]+)\]\]/g, '<a href="javascript:void(0)" onclick="navigateWiki(\'$1\')" style="color:var(--brand-600);border-bottom:1px dashed var(--brand-300)">ğŸ“ $1</a>');
  
  if(typeof marked !== 'undefined' && marked.parse) {
    document.getElementById('preview-content').innerHTML = marked.parse(processed);
  } else {
    document.getElementById('preview-content').innerHTML = processed;
  }
}

// æ›´æ–°è®¡æ•°
function updateCounts(){
  const c = document.getElementById('note-content').value || '';
  document.getElementById('char-count').textContent = c.replace(/\s+/g, '').length + ' å­—';
  document.getElementById('word-count').textContent = (c.trim() ? c.trim().split(/\s+/).length : 0) + ' è¯';
  document.getElementById('line-count').textContent = c.split('\n').length + ' è¡Œ';
}

// æ›´æ–°æ ‡ç­¾
function updateTags(){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  document.getElementById('tag-display').innerHTML = (n.tags || []).map(t => 
    '<span class="badge" style="background:rgba(34,197,94,0.1);color:#16A34A;border:1px solid rgba(34,197,94,0.2)">' + t + ' <button onclick="removeTag(\'' + t + '\')" style="background:none;border:none;cursor:pointer;color:inherit;font-size:12px;margin-left:2px">Ã—</button></span>'
  ).join('');
}

// æ›´æ–°æ–‡ä»¶å¤¹æ˜¾ç¤º
function updateFolder(){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  document.getElementById('folder-display').textContent = n.folder || 'æ— æ–‡ä»¶å¤¹';
}

// ä¾§è¾¹é¢æ¿
function updateSidePanel(){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  
  // ç‰ˆæœ¬å†å²
  let vh = '<div class="version-item text-xs" style="color:var(--text-tertiary)" onclick="restoreCurrent()">å½“å‰ç‰ˆæœ¬</div>';
  (n.versions || []).slice().reverse().forEach((v, i) => {
    vh += '<div class="version-item text-xs" onclick="restoreVersion(' + (n.versions.length - 1 - i) + ')"><div style="color:var(--text-primary)">' + (v.title || 'æ— æ ‡é¢˜') + '</div><div style="color:var(--text-tertiary)">' + timeAgo(v.timestamp) + '</div></div>';
  });
  document.getElementById('version-list').innerHTML = vh || '<div class="px-2 py-2 text-xs" style="color:var(--text-tertiary)">æš‚æ— å†å²</div>';
  
  // åå‘é“¾æ¥
  const backlinks = notes.filter(x => x.id !== activeId && !x.deleted && (x.content || '').includes('[[' + n.title + ']]'));
  let bh = '';
  backlinks.forEach(b => {
    bh += '<div class="backlink-item" onclick="selectNote(\'' + b.id + '\')"><div style="color:var(--text-primary)">' + (b.title || 'æ— æ ‡é¢˜') + '</div></div>';
  });
  document.getElementById('backlink-list').innerHTML = bh || '<div class="px-2 py-2 text-xs" style="color:var(--text-tertiary)">æš‚æ— é“¾æ¥</div>';
}

// æ¢å¤ç‰ˆæœ¬
function restoreVersion(idx){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  const v = n.versions[idx];
  if(!v) return;
  if(confirm('æ¢å¤åˆ°è¯¥ç‰ˆæœ¬ï¼Ÿå½“å‰å†…å®¹å°†ä¿å­˜ä¸ºæ–°ç‰ˆæœ¬ã€‚')) {
    n.versions.push({title: n.title, content: n.content, timestamp: n.updatedAt});
    n.title = v.title;
    n.content = v.content;
    n.updatedAt = Date.now();
    save();
    selectNote(activeId);
  }
}

// æ¢å¤å½“å‰
function restoreCurrent(){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  document.getElementById('note-title').value = n.title;
  document.getElementById('note-content').value = n.content;
  updateCounts();
  updatePreview();
}

// æ ‡ç­¾æ“ä½œ
function promptAddTag(){
  const tag = prompt('è¾“å…¥æ ‡ç­¾å:');
  if(!tag || !tag.trim()) return;
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  if(!n.tags) n.tags = [];
  if(!n.tags.includes(tag.trim())) {
    n.tags.push(tag.trim());
    save();
    updateTags();
    renderList();
  }
}

function removeTag(tag){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  n.tags = (n.tags || []).filter(t => t !== tag);
  save();
  updateTags();
  renderList();
}

// æ–‡ä»¶å¤¹æ“ä½œ
function promptSelectFolder(){
  const n = notes.find(x => x.id === activeId);
  if(!n) return;
  const folder = prompt('è¾“å…¥æ–‡ä»¶å¤¹åç§° (ç•™ç©ºä¸ºæ— æ–‡ä»¶å¤¹):', n.folder || '');
  if(folder === null) return;
  n.folder = folder.trim();
  save();
  updateFolder();
  renderList();
}

// è§†å›¾æ¨¡å¼
function setEditMode(mode){
  editMode = mode;
  document.querySelectorAll('.view-tab').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-' + mode).classList.add('active');
  
  const editPane = document.getElementById('edit-pane');
  const previewPane = document.getElementById('preview-pane');
  const toolbar = document.getElementById('md-toolbar');
  
  if(mode === 'edit') {
    editPane.classList.remove('hidden');
    previewPane.classList.add('hidden');
    toolbar.classList.remove('hidden');
  } else if(mode === 'preview') {
    editPane.classList.add('hidden');
    previewPane.classList.remove('hidden');
    toolbar.classList.add('hidden');
    updatePreview();
  } else {
    editPane.classList.remove('hidden');
    previewPane.classList.remove('hidden');
    toolbar.classList.remove('hidden');
    updatePreview();
  }
}

// åˆ‡æ¢ä¾§è¾¹é¢æ¿
function toggleSidePanel(){
  showSidePanel = !showSidePanel;
  const panel = document.getElementById('side-panel');
  if(showSidePanel) {
    panel.classList.remove('hidden');
    updateSidePanel();
  } else {
    panel.classList.add('hidden');
  }
}

// æ’å…¥ Markdown
function insertMd(before, after = ''){
  const ta = document.getElementById('note-content');
  const start = ta.selectionStart;
  const end = ta.selectionEnd;
  const text = ta.value;
  const sel = text.substring(start, end);
  ta.value = text.substring(0, start) + before + sel + after + text.substring(end);
  ta.selectionStart = ta.selectionEnd = start + before.length + sel.length;
  ta.focus();
  autoSave();
}

// Wiki é“¾æ¥å¯¼èˆª
function navigateWiki(title){
  const target = notes.find(n => (n.title || '').toLowerCase() === title.toLowerCase() && !n.deleted);
  if(target) {
    selectNote(target.id);
  } else {
    if(confirm('ç¬”è®° "' + title + '" ä¸å­˜åœ¨ï¼Œæ˜¯å¦åˆ›å»ºï¼Ÿ')) {
      const n = {
        id: crypto.randomUUID(),
        title,
        content: '',
        folder: '',
        tags: [],
        pinned: false,
        deleted: false,
        versions: [],
        createdAt: Date.now(),
        updatedAt: Date.now()
      };
      notes.unshift(n);
      save();
      renderList();
      selectNote(n.id);
    }
  }
}

// å¯¼å‡ºå¯¼å…¥
function exportNotes(){
  const blob = new Blob([JSON.stringify(notes.filter(n => !n.deleted), null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'spc-notes-' + new Date().toISOString().slice(0, 10) + '.json';
  a.click();
}

function importNotes(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const arr = JSON.parse(ev.target.result);
        if(!Array.isArray(arr)) return;
        arr.forEach(n => {
          if(!n.id) return;
          const i = notes.findIndex(x => x.id === n.id);
          if(i >= 0) notes[i] = {...notes[i], ...n};
          else notes.push({...n, tags: n.tags || [], pinned: n.pinned || false, deleted: false, versions: n.versions || [], folder: n.folder || ''});
        });
        save();
        renderList();
        alert('å¯¼å…¥æˆåŠŸ: ' + arr.length + ' ç¯‡');
      } catch {}
    };
    r.readAsText(f);
  };
  input.click();
}

// å¿«æ·é”®
document.addEventListener('keydown', e => {
  if((e.ctrlKey || e.metaKey) && e.key === 'n') {
    e.preventDefault();
    createNote();
  }
  if((e.ctrlKey || e.metaKey) && e.key === 'p') {
    e.preventDefault();
    setEditMode(editMode === 'preview' ? 'edit' : 'preview');
  }
});

// å†…å®¹å˜åŒ–ç›‘å¬
document.getElementById('note-content').addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = Math.max(this.scrollHeight, 400) + 'px';
  autoSave();
});

// åˆå§‹åŒ–
console.log('[Note] Initializing...');
load();
setView('all');
renderList();
if(notes.filter(n => !n.deleted).length) selectNote(notes.filter(n => !n.deleted)[0].id);
console.log('[Note] Ready!');
</script>
</body>
</html>
